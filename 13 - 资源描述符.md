# 13 - 资源描述符

描述符是一种不透明的数据结构，代表着色器资源，如缓冲区、缓冲区视图、图像视图、采样器或组合图像采样器。描述符被组织成描述符集，这些描述符集在命令记录过程中被绑定，以便在后续绘图命令中使用。每个描述符集的内容排列由描述符集布局决定，描述符集布局决定了其中可以存储哪些描述符。管道可使用的描述符集布局序列在管道布局中指定。每个管道对象最多可使用 maxBoundDescriptorSets（请参阅 "限制"）描述符集。

如果启用了描述符缓冲区（descriptorBuffer）功能，执行程序将支持将描述符放入描述符缓冲区，这些缓冲区将在命令录制过程中以与描述符集类似的方式绑定。

着色器通过使用描述符集和绑定编号装饰的变量访问资源，这些变量与描述符集中的描述符相连。着色器接口与绑定描述符集的映射关系在着色器资源接口部分进行了描述。

着色器还可以使用物理存储缓冲区访问（Physical Storage Buffer Access）功能，通过 64 位地址访问缓冲区，而无需通过描述符

## 描述符类型

Vulkan 支持多种不同类型的描述符，分别对应不同的资源或用途。以下各节描述了每种描述符类型的 API 定义。着色器接口 "一章中的 "着色器资源与描述符类型对应关系 "和 "着色器资源与存储类对应关系 "表中列出了每种类型与 SPIR-V 的映射关系。

### 存储图像

存储图像 (VK_DESCRIPTOR_TYPE_STORAGE_IMAGE) 是一种通过图像视图与图像资源关联的描述符类型，可对其执行加载、存储和原子操作。

- 对于格式特征包含 VK_FORMAT_FEATURE_STORAGE_IMAGE_BIT 的图像视图，所有着色器阶段都支持加载存储图像。
- 对于格式特征包含 VK_FORMAT_FEATURE_STORAGE_IMAGE_BIT 的图像视图，任务、网格和计算着色器都支持存储图像的存储。
- 对于格式特征包含 VK_FORMAT_FEATURE_STORAGE_IMAGE_ATOMIC_BIT 的图像视图，任务、网格和计算着色器都支持对存储图像进行原子操作。

启用 fragmentStoresAndAtomics 功能后，片段着色器中的存储图像也支持存储和原子操作，其图像格式集与计算着色器中支持的相同。
启用顶点流水线存储和原子特性后，顶点、细分和几何着色器中也支持存储和原子操作，其图像格式集与计算着色器中支持的相同。

存储图像的图像子资源必须位于 VK_IMAGE_LAYOUT_SHARED_PRESENT_KHR 或 VK_IMAGE_LAYOUT_GENERAL 布局中，才能在着色器中访问其数据。

### 采样器

采样器描述符（VK_DESCRIPTOR_TYPE_SAMPLER）是与采样器对象相关联的描述符类型，用于控制对采样图像执行采样操作的行为。

### 采样图像

采样图像（VK_DESCRIPTOR_TYPE_SAMPLED_IMAGE）是一种通过图像视图与图像资源相关联的描述符类型，可以对其执行采样操作。

着色器结合采样图像变量和采样器变量来执行采样操作。

对于格式特征包含 VK_FORMAT_FEATURE_SAMPLED_IMAGE_BIT 的图像视图，所有着色器阶段都支持采样图像。

采样图像的图像子资源必须是以下布局之一：

- vk_image_layout_depth_stencil_read_only_optimal
- vk_image_layout_shader_read_only_optimal
- vk_image_layout_general
- vk_image_layout_shared_present_khr
- vk_image_layout_depth_read_only_stencil_attachment_optimal
- vk_image_layout_depth_attachment_stencil_read_only_optimal
- vk_image_layout_depth_read_only_optimal
- vk_image_layout_stencil_read_only_optimal
- vk_image_layout_read_only_optimal_khr
- vk_image_layout_attachment_feedback_loop_optimal_ext

### 组合采样图像

组合图像采样器（VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER）是同时与采样器和图像资源相关联的单一描述符类型，它将采样器和采样图像描述符组合成单一描述符。

如果该描述符指向一个执行 $Y'C_B C_R$ 转换或对子采样图像进行采样的采样器，则该采样器只能用于对同一描述符中的图像进行采样。否则，此类描述符中的采样器和图像可与任何其他采样器和图像一起自由使用。

组合图像采样器的图像子资源必须采用以下布局之一：

- vk_image_layout_depth_stencil_read_only_optimal
- vk_image_layout_shader_read_only_optimal
- vk_image_layout_general
- vk_image_layout_shared_present_khr
- vk_image_layout_depth_read_only_stencil_attachment_optimal
- vk_image_layout_depth_attachment_stencil_read_only_optimal
- vk_image_layout_depth_read_only_optimal
- vk_image_layout_stencil_read_only_optimal
- vk_image_layout_read_only_optimal_khr
- vk_image_layout_attachment_feedback_loop_optimal_ext

> [!note]
> 在某些实现中，使用采样器和采样图像的组合从图像中采样可能更有效率，这些采样器和采样图像一起存储在描述符集中的组合描述符中。

### Uniform 纹理元缓冲

> [!note] Texel 纹理元
> ![](https://img-blog.csdn.net/20170315165913210)

Uniform 纹理元缓冲区（VK_DESCRIPTOR_TYPE_UNIFORM_TEXEL_BUFFER）是一种通过缓冲区视图与缓冲区资源相关联的描述符类型，可对其执行图像采样操作。

Uniform 纹理元缓冲区定义了一个紧密堆积的一维线性纹理元数组，在着色器中读取纹理元时，纹理元会按照与图像相同的方式进行格式转换。

对于报告格式特征支持 VK_FORMAT_FEATURE_UNIFORM_TEXEL_BUFFER_BIT 的缓冲视图格式，所有着色器阶段都支持从 Uniform 纹理元缓冲区加载操作。

### 存储纹理元缓冲

存储纹理元缓冲区（VK_DESCRIPTOR_TYPE_STORAGE_TEXEL_BUFFER）是一种通过缓冲区视图与缓冲区资源相关联的描述符类型，可对其执行图像加载、存储和原子操作。

存储纹理元缓冲区定义了一个紧密堆积的一维线性纹理元数组，在着色器中读取纹理元时，纹理元会按照与图像相同的方式进行格式转换。与统一纹理元缓冲区不同的是，这些缓冲区也可以用与存储图像相同的方式写入。

- 对于报告格式特征支持 VK_FORMAT_FEATURE_STORAGE_TEXEL_BUFFER_BIT 的纹理缓冲视图格式，所有着色器阶段都支持存储纹理元缓冲区加载。
- 对于报告格式支持 VK_FORMAT_FEATURE_STORAGE_TEXEL_BUFFER_BIT 的纹理缓冲区格式，任务、网格和计算着色器都支持存储到纹理缓冲区的存储空间
- 对于报告格式特征支持 VK_FORMAT_FEATURE_STORAGE_TEXEL_BUFFER_ATOMIC_BIT 的纹理缓冲区格式，任务、网格和计算着色器都支持对存储纹理缓冲区进行原子操作

启用 fragmentStoresAndAtomics 功能后，片元着色器中的存储纹理元缓冲区也支持存储和原子操作，其纹理元缓冲区格式集与计算着色器中支持的相同。启用 vertexPipelineStoresAndAtomics 功能后，顶点着色器、细分着色器和几何着色器中也支持存储和原子操作，其纹理缓冲区格式集与计算着色器中支持的相同。

### 存储缓冲

存储缓冲区（VK_DESCRIPTOR_TYPE_STORAGE_BUFFER）是一种直接与缓冲区资源相关联的描述符类型，在着色器中被描述为一种结构，其中包含可对其执行加载、存储和原子操作的各种成员。

> [!note]
> 原子操作只能对 SPIR-V 环境附录中定义的某些类型的成员执行。

### Uniform 缓冲区

统一缓冲区 (VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER) 是一种直接与缓冲区资源相关联的描述符类型，在着色器中被描述为具有各种成员的结构，可对其执行加载操作。

### 动态 Uniform 缓冲区

动态统一缓冲区（VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER_DYNAMIC）与统一缓冲区几乎完全相同，区别仅在于如何指定缓冲区的偏移量。在绑定描述符集时，VkDescriptorBufferInfo 在初始更新描述符集时计算的基本偏移量会被添加到动态偏移量中。

### 动态存储缓冲区

动态存储缓冲区 (VK_DESCRIPTOR_TYPE_STORAGE_BUFFER_DYNAMIC) 与存储缓冲区几乎完全相同，区别仅在于如何指定缓冲区的偏移量。在绑定描述符集时，VkDescriptorBufferInfo 在初始更新描述符集时计算的基本偏移量会被添加到动态偏移量中。

### 内联 Uniform 块

内联 Uniform 块 (VK_DESCRIPTOR_TYPE_INLINE_UNIFORM_BLOCK) 与 Uniform 缓冲区几乎完全相同，区别仅在于其存储空间直接取自包含的描述符集，而不是由缓冲区内存支持。它通常用于访问一小部分常量数据，这些数据不需要使用统一缓冲区（描述符和引用的缓冲区内存是解耦的）时通过间接方式提供的额外灵活性。与推送常量相比，它们允许在多个不相连的绘图和调度命令集中重复使用同一组常量数据。

内联统一块描述符不能聚合到数组中。相反，为内联统一块描述符绑定指定的数组大小指定了以字节为单位的绑定容量。

### 采样权重图像

采样权重图像（VK_DESCRIPTOR_TYPE_SAMPLE_WEIGHT_IMAGE_QCOM）是通过图像视图与图像资源关联的描述符类型，可用于采样权重图像。必须使用 VkImageViewSampleWeightCreateInfoQCOM 创建图像视图。

着色器可以结合权重图像变量、采样图像变量和采样器变量来执行权重图像采样。

如果权重图像视图指定的格式支持格式特征 VK_FORMAT_FEATURE_2_WEIGHT_IMAGE_BIT_QCOM，且采样图像视图指定的格式支持格式特征 VK_FORMAT_FEATURE_2_WEIGHT_SAMPLED_IMAGE_BIT_QCOM，那么所有着色器阶段都支持采样权重图像。

权重图像的图像子资源必须位于 VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL 或 VK_IMAGE_LAYOUT_GENERAL 布局中，以便在着色器中访问其数据。

### 块匹配图像

块匹配图像（VK_DESCRIPTOR_TYPE_BLOCK_MATCH_IMAGE_QCOM）是一种通过图像视图与图像资源关联的描述符类型，可用于块匹配。

着色器可以结合目标图像变量、参考图像变量和采样器变量来执行块匹配。

如果目标视图和参考视图都指定了支持格式特征 VK_FORMAT_FEATURE_2_BLOCK_MATCHING_BIT_QCOM 的格式，则所有着色器阶段都支持块匹配。

用于块匹配的图像子资源必须位于 VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL 或 VK_IMAGE_LAYOUT_GENERAL 布局中，才能在着色器中访问其数据。

### 输入附件

输入附件（VK_DESCRIPTOR_TYPE_INPUT_ATTACHMENT）是一种通过图像视图与图像资源关联的描述符类型，可用于片段着色器中的帧缓冲本地加载操作。

对于给定的图像平铺模式，所有支持颜色附件（VK_FORMAT_FEATURE_COLOR_ATTACHMENT_BIT 或 VK_FORMAT_FEATURE_2_LINEAR_COLOR_ATTACHMENT_BIT_NV ）或深度/模板附件（VK_FORMAT_FEATURE_DEPTH_STENCIL_TATACHMENT_BIT）的图像格式也都支持输入附件。

用作输入附件的图像视图必须是以下布局之一：

- vk_image_layout_depth_stencil_read_only_optimal
- vk_image_layout_shader_read_only_optimal
- vk_image_layout_general
- vk_image_layout_shared_present_khr
- vk_image_layout_depth_read_only_stencil_attachment_optimal
- vk_image_layout_depth_attachment_stencil_read_only_optimal
- vk_image_layout_read_only_optimal_khr
- vk_image_layout_attachment_feedback_loop_optimal_ext
- vk_image_layout_rendering_local_read_khr

### 加速结构

加速结构（VK_DESCRIPTOR_TYPE_ACCELERATION_STRUCTURE_KHR 或 VK_DESCRIPTOR_TYPE_ACCELERATION_STRUCTURE_NV ）是一种描述符类型，用于从用于光线遍历的着色器中检索场景几何图形。着色器对内存具有只读访问权限。

### Mutable（可变类型描述符）

一个 Mutable (VK_DESCRIPTOR_TYPE_MUTABLE_EXT) 类型的描述符表示此描述符可以变为此绑定的 VkDescriptorSetLayoutCreateInfo 的 pNext 链中的 VkMutableDescriptorTypeListEXT::pDescriptorTypes 描述符类型列表中给出的任何描述符类型。在任何时候，每个 Mutable 类型的描述符都有一个活动描述符类型。活动描述符类型可以是 pDescriptorType 中声明的任何一种类型。此外，Mutable 描述符的活动描述符类型可以是 VK_DESCRIPTOR_TYPE_MUTABLE_EXT 类型，即初始活动描述符类型。在更新描述符时，活动描述符类型会发生变化。通过绑定描述符集消耗描述符时，考虑的是活动描述符类型，而不是 VK_DESCRIPTOR_TYPE_MUTABLE_EXT。

如果活动描述符类型为 VK_DESCRIPTOR_TYPE_MUTABLE_EXT，则视为未定义的描述符。如果消耗的描述符的活动描述符类型与着色器期望的类型不匹配，则该描述符将被视为未定义的描述符。

> [!note]
> 要查找哪些描述符类型作为 VK_DESCRIPTOR_TYPE_MUTABLE_EXT 受支持，应用程序可以使用 vkGetDescriptorSetLayoutSupport 和 VK_DESCRIPTOR_TYPE_MUTABLE_EXT 绑定，并在 VkMutableDescriptorTypeCreateInfoEXT::pDescriptorTypes 数组中查询该绑定的描述符类型列表。

> [!note]
> Mutable 描述符类型的目的是让实现为每个描述符分配 N 字节，其中 N 字节由给定描述符绑定的最大描述符大小决定。实现过程中不需要跟踪活动描述符类型，它应被视为类似于 C 语言的联合（Union）类型。
>
> 就运行时性能而言，Mutable 描述符类型不如非 Mutable 描述符类型高效，因此不鼓励应用程序在 API 分层之外使用 Mutable 描述符类型。如果使用许多不同的描述符来模拟 Mutable 描述符类型，Mutable 描述符类型的效率会更高。

## 描述符集

描述符被组合到描述符集对象中。描述符集对象是一个不透明对象，包含一组描述符的存储空间，其中描述符的类型和数量由描述符集布局定义。布局对象可用于定义每个描述符绑定与内存或其他执行资源的关联。布局既可用于确定需要与描述符集关联的资源，也可用于确定着色器阶段和着色器资源之间的接口。

### 描述符集布局

描述符集布局对象由一个包含零个或多个描述符绑定的数组定义。每个单独的描述符绑定由描述符类型、绑定中描述符数量的计数（数组大小）、可访问绑定的着色器阶段集以及（如果使用不可变采样器）采样器描述符数组指定。

### 管线布局

通过管线布局可以访问管线中的描述符集。零个或多个描述符集布局和零个或多个推送常数范围组合在一起，形成一个管线布局对象，描述管线可访问的整套资源。管线布局表示描述符集的序列，每个描述符集都有特定的布局。该布局序列用于确定着色器阶段和着色器资源之间的接口。每个管线都是通过管线布局创建的。
